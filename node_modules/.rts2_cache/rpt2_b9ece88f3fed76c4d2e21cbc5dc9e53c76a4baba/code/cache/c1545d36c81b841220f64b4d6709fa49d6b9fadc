{"code":"var _a;\r\nimport { ReactiveEffect } from './effect';\r\nimport { toRaw } from './reactive';\r\nimport { trackRefValue, triggerRefValue } from './ref';\r\nconst tick = Promise.resolve();\r\nconst queue = [];\r\nlet queued = false;\r\nconst scheduler = (fn) => {\r\n    queue.push(fn);\r\n    if (!queued) {\r\n        queued = true;\r\n        tick.then(flush);\r\n    }\r\n};\r\nconst flush = () => {\r\n    for (let i = 0; i < queue.length; i++) {\r\n        queue[i]();\r\n    }\r\n    queue.length = 0;\r\n    queued = false;\r\n};\r\nclass DeferredComputedRefImpl {\r\n    constructor(getter) {\r\n        this.dep = undefined;\r\n        this._dirty = true;\r\n        this.__v_isRef = true;\r\n        this[_a] = true;\r\n        let compareTarget;\r\n        let hasCompareTarget = false;\r\n        let scheduled = false;\r\n        this.effect = new ReactiveEffect(getter, (computedTrigger) => {\r\n            if (this.dep) {\r\n                if (computedTrigger) {\r\n                    compareTarget = this._value;\r\n                    hasCompareTarget = true;\r\n                }\r\n                else if (!scheduled) {\r\n                    const valueToCompare = hasCompareTarget ? compareTarget : this._value;\r\n                    scheduled = true;\r\n                    hasCompareTarget = false;\r\n                    scheduler(() => {\r\n                        if (this.effect.active && this._get() !== valueToCompare) {\r\n                            triggerRefValue(this);\r\n                        }\r\n                        scheduled = false;\r\n                    });\r\n                }\r\n                // chained upstream computeds are notified synchronously to ensure\r\n                // value invalidation in case of sync access; normal effects are\r\n                // deferred to be triggered in scheduler.\r\n                for (const e of this.dep) {\r\n                    if (e.computed) {\r\n                        e.scheduler(true /* computedTrigger */);\r\n                    }\r\n                }\r\n            }\r\n            this._dirty = true;\r\n        });\r\n        this.effect.computed = true;\r\n    }\r\n    _get() {\r\n        if (this._dirty) {\r\n            this._dirty = false;\r\n            return (this._value = this.effect.run());\r\n        }\r\n        return this._value;\r\n    }\r\n    get value() {\r\n        trackRefValue(this);\r\n        // the computed ref may get wrapped by other proxies e.g. readonly() #3376\r\n        return toRaw(this)._get();\r\n    }\r\n}\r\n_a = \"__v_isReadonly\" /* IS_READONLY */;\r\nexport function deferredComputed(getter) {\r\n    return new DeferredComputedRefImpl(getter);\r\n}\r\n//# sourceMappingURL=deferredComputed.js.map","references":["/Users/zhangpian/Documents/projects/github/vue-next-3.2.24/packages/reactivity/src/dep.ts","/Users/zhangpian/Documents/projects/github/vue-next-3.2.24/packages/reactivity/src/effect.ts","/Users/zhangpian/Documents/projects/github/vue-next-3.2.24/packages/reactivity/src/computed.ts","/Users/zhangpian/Documents/projects/github/vue-next-3.2.24/packages/reactivity/src/reactive.ts","/Users/zhangpian/Documents/projects/github/vue-next-3.2.24/packages/reactivity/src/ref.ts"],"map":"{\"version\":3,\"file\":\"deferredComputed.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../packages/reactivity/src/deferredComputed.ts\"],\"names\":[],\"mappings\":\"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\"}"}
