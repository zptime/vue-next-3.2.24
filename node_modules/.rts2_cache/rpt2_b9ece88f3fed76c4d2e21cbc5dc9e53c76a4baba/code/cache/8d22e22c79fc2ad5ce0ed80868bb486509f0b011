{"code":"import { currentInstance, isInSSRComponentSetup } from './component';\r\nimport { isFunction, isObject } from '@vue/shared';\r\nimport { createVNode } from './vnode';\r\nimport { defineComponent } from './apiDefineComponent';\r\nimport { warn } from './warning';\r\nimport { ref } from '@vue/reactivity';\r\nimport { handleError } from './errorHandling';\r\nimport { isKeepAlive } from './components/KeepAlive';\r\nimport { queueJob } from './scheduler';\r\nexport const isAsyncWrapper = (i) => !!i.type.__asyncLoader;\r\nexport function defineAsyncComponent(source) {\r\n    if (isFunction(source)) {\r\n        source = { loader: source };\r\n    }\r\n    const { loader, loadingComponent, errorComponent, delay = 200, timeout, // undefined = never times out\r\n    suspensible = true, onError: userOnError } = source;\r\n    let pendingRequest = null;\r\n    let resolvedComp;\r\n    let retries = 0;\r\n    const retry = () => {\r\n        retries++;\r\n        pendingRequest = null;\r\n        return load();\r\n    };\r\n    const load = () => {\r\n        let thisRequest;\r\n        return (pendingRequest ||\r\n            (thisRequest = pendingRequest =\r\n                loader()\r\n                    .catch(err => {\r\n                    err = err instanceof Error ? err : new Error(String(err));\r\n                    if (userOnError) {\r\n                        return new Promise((resolve, reject) => {\r\n                            const userRetry = () => resolve(retry());\r\n                            const userFail = () => reject(err);\r\n                            userOnError(err, userRetry, userFail, retries + 1);\r\n                        });\r\n                    }\r\n                    else {\r\n                        throw err;\r\n                    }\r\n                })\r\n                    .then((comp) => {\r\n                    if (thisRequest !== pendingRequest && pendingRequest) {\r\n                        return pendingRequest;\r\n                    }\r\n                    if (__DEV__ && !comp) {\r\n                        warn(`Async component loader resolved to undefined. ` +\r\n                            `If you are using retry(), make sure to return its return value.`);\r\n                    }\r\n                    // interop module default\r\n                    if (comp &&\r\n                        (comp.__esModule || comp[Symbol.toStringTag] === 'Module')) {\r\n                        comp = comp.default;\r\n                    }\r\n                    if (__DEV__ && comp && !isObject(comp) && !isFunction(comp)) {\r\n                        throw new Error(`Invalid async component load result: ${comp}`);\r\n                    }\r\n                    resolvedComp = comp;\r\n                    return comp;\r\n                })));\r\n    };\r\n    return defineComponent({\r\n        name: 'AsyncComponentWrapper',\r\n        __asyncLoader: load,\r\n        get __asyncResolved() {\r\n            return resolvedComp;\r\n        },\r\n        setup() {\r\n            const instance = currentInstance;\r\n            // already resolved\r\n            if (resolvedComp) {\r\n                return () => createInnerComp(resolvedComp, instance);\r\n            }\r\n            const onError = (err) => {\r\n                pendingRequest = null;\r\n                handleError(err, instance, 13 /* ASYNC_COMPONENT_LOADER */, !errorComponent /* do not throw in dev if user provided error component */);\r\n            };\r\n            // suspense-controlled or SSR.\r\n            if ((__FEATURE_SUSPENSE__ && suspensible && instance.suspense) ||\r\n                (__SSR__ && isInSSRComponentSetup)) {\r\n                return load()\r\n                    .then(comp => {\r\n                    return () => createInnerComp(comp, instance);\r\n                })\r\n                    .catch(err => {\r\n                    onError(err);\r\n                    return () => errorComponent\r\n                        ? createVNode(errorComponent, {\r\n                            error: err\r\n                        })\r\n                        : null;\r\n                });\r\n            }\r\n            const loaded = ref(false);\r\n            const error = ref();\r\n            const delayed = ref(!!delay);\r\n            if (delay) {\r\n                setTimeout(() => {\r\n                    delayed.value = false;\r\n                }, delay);\r\n            }\r\n            if (timeout != null) {\r\n                setTimeout(() => {\r\n                    if (!loaded.value && !error.value) {\r\n                        const err = new Error(`Async component timed out after ${timeout}ms.`);\r\n                        onError(err);\r\n                        error.value = err;\r\n                    }\r\n                }, timeout);\r\n            }\r\n            load()\r\n                .then(() => {\r\n                loaded.value = true;\r\n                if (instance.parent && isKeepAlive(instance.parent.vnode)) {\r\n                    // parent is keep-alive, force update so the loaded component's\r\n                    // name is taken into account\r\n                    queueJob(instance.parent.update);\r\n                }\r\n            })\r\n                .catch(err => {\r\n                onError(err);\r\n                error.value = err;\r\n            });\r\n            return () => {\r\n                if (loaded.value && resolvedComp) {\r\n                    return createInnerComp(resolvedComp, instance);\r\n                }\r\n                else if (error.value && errorComponent) {\r\n                    return createVNode(errorComponent, {\r\n                        error: error.value\r\n                    });\r\n                }\r\n                else if (loadingComponent && !delayed.value) {\r\n                    return createVNode(loadingComponent);\r\n                }\r\n            };\r\n        }\r\n    });\r\n}\r\nfunction createInnerComp(comp, { vnode: { ref, props, children } }) {\r\n    const vnode = createVNode(comp, props, children);\r\n    // ensure inner component inherits the async wrapper's ref owner\r\n    vnode.ref = ref;\r\n    return vnode;\r\n}\r\n//# sourceMappingURL=apiAsyncComponent.js.map","references":["/Users/zhangpian/Documents/projects/github/vue-next-3.2.24/packages/runtime-core/src/component.ts","/Users/zhangpian/Documents/projects/github/vue-next-3.2.24/packages/shared/src/index.ts","/Users/zhangpian/Documents/projects/github/vue-next-3.2.24/packages/runtime-core/src/componentPublicInstance.ts","/Users/zhangpian/Documents/projects/github/vue-next-3.2.24/packages/runtime-core/src/vnode.ts","/Users/zhangpian/Documents/projects/github/vue-next-3.2.24/packages/runtime-core/src/apiDefineComponent.ts","/Users/zhangpian/Documents/projects/github/vue-next-3.2.24/packages/runtime-core/src/warning.ts","/Users/zhangpian/Documents/projects/github/vue-next-3.2.24/packages/reactivity/src/index.ts","/Users/zhangpian/Documents/projects/github/vue-next-3.2.24/packages/runtime-core/src/errorHandling.ts","/Users/zhangpian/Documents/projects/github/vue-next-3.2.24/packages/runtime-core/src/components/KeepAlive.ts","/Users/zhangpian/Documents/projects/github/vue-next-3.2.24/packages/runtime-core/src/scheduler.ts"],"map":"{\"version\":3,\"file\":\"apiAsyncComponent.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../packages/runtime-core/src/apiAsyncComponent.ts\"],\"names\":[],\"mappings\":\"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\"}"}
